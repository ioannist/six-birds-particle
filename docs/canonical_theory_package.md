# Canonical Theory Package - Ratchet Playground (particles substrate)

This document defines the canonical theory package

  T = (Z, f, Sigma_f, E, A)

for the playground substrate, using the framework paper `docs/six-birds-paper.tex` terminology and symbols as canonical. This repo includes that snapshot for convenience; it may differ slightly from the external canonical paper. Repo-native terms are recorded only as aliases.

## 0. Alias map (repo -> paper.tex)

- "protocol-cycle" -> P3 holonomy / route-mismatch diagnostic (not an arrow-of-time certificate).
- "closure/viability field", "safe set" -> completion/packaging endomap E and its fixed points.
- "irreversibility diagnostics", "affinity", "Sigma_mem", "M6" -> audit functional A (ACC affinities / path-asymmetry proxies).
- "operator lifting", "K tokens", "op coupling" -> part of microstate Z and lens family f_opk.
- "diagnostics" / "readout" -> lens f and its definability structure Sigma_f.

## 1. Microstate space Z

### Z_raw (simulator state)

The simulator state is the `Sim` struct in `crates/sim-core/src/lib.rs` and includes:
- particle positions on the torus: positions[i] = (x_i, y_i)
- P1 bonds w_ij (upper-triangular weights)
- P2 apparatus counters a_i
- P4 counters n_i
- P5 field S_q on a grid
- meta-layer fields (meta_field, meta_n_field, meta_a_field, meta_w_edges)
- operator-lifted tokens op_k
- protocol phase (phase, p3_cycle_len, p3 observables)
- clock state and clock current (clock_state, clock_q, clock_fwd, clock_bwd)

See `crates/sim-core/src/lib.rs#L49` and `crates/sim-core/src/lib.rs#L85` for the state variables.

### Z_fin (finite microstate for the theory package)

`paper.tex` assumes a finite Z. We therefore define a finite version of the simulator state by discretizing positions into grid cells at the configured `gridSize` (the same grid used for S and op_k). All other variables are already discrete and bounded:
- w_ij in {0..L_w}
- a_i in {0..L_a}
- n_i in {-L_n..L_n}
- S_q in {0..L_S}
- op_k tokens are bounded by opBudgetK per cell
- phase in {0..(p3_cycle_len-1)} and clock_state in {0..(clock_k-1)}

Canonical Z for the theory package is Z_fin. Z_raw is the underlying simulator and is referenced where implementation details are needed. The mu context used for P6 (x < 0.5 vs x >= 0.5) is defined in `crates/sim-core/src/lib.rs#L2595`.

The null-regime state description and energy function are specified in `docs/knowledge/08_deliverable_A_null_stationary_measure.md#L12`.

## 2. Lens f: Z -> X and definability Sigma_f

We use a small family of lenses; each induces a finite partition Sigma_f of Z by equality of the lens output.

### f_diag (windowed diagnostics lens)

f_diag maps a window of accepted events to the diagnostics vector used in the UI and logs:
- counts N_y^+, N_y^- for y in {w, a, n, S}
- affinities A_y and Sigma_mem
- M6 motif affinities aM6*
- P3 diagnostics (p3Disp, p3LoopArea)
- histograms of w and S

Implementation:
- Event counts are accumulated in `DiagTotals` (`crates/sim-core/src/lib.rs#L2766`) via `Sim.step` (`crates/sim-core/src/lib.rs#L287`).
- Affinities and Sigma_mem are computed in `diagnostics()` using `diag_flux_affinity` (`crates/sim-core/src/lib.rs#L2859`).
- M6 affinities are computed by `diag_m6_affinity` (`crates/sim-core/src/lib.rs#L2869`).
- P3 disp/loop are computed in `update_p3_cycle_diagnostics` (`crates/sim-core/src/lib.rs#L2323`).

This lens corresponds to the formulas in `docs/knowledge/11_deliverable_D_diagnostics.md#L31`.

### f_safe (P5 safe-set lens)

f_safe projects to the P5 field S_q and its thresholded safe set. The UI computes safe-set fraction, components, and largest component from the base S field:
- `computeSafeSetStats` in `apps/web/src/App.tsx#L555`
- `s_hist` and `field` from `Sim.diagnostics()` / `Sim.field()` in `crates/sim-core/src/lib.rs#L737`

This lens corresponds to the safe-set observable in `docs/knowledge/11_deliverable_D_diagnostics.md#L122`.

### f_opk (operator-lifted coupling lens)

f_opk projects to the operator-lifted token field op_k and derived interface metrics such as Sdiff_op, R2, H, and coherence. These are computed in `scripts/opk-metrics.mjs#L34` and used in op-coupling campaigns.

### Refinement relation

Each lens is a coarsening of Z_fin: f_safe and f_opk ignore particle positions and most fast variables; f_diag ignores spatial microstate except through event counts and context bins. When needed, f_safe and f_opk can be composed with a joint lens that retains both S and op_k (refinement by product lens). Sigma_f is the partition generated by the chosen lens.

## 3. Description space V

We use the finite description space associated to each lens:
- V_diag = Delta(X_diag), where X_diag is the finite space of windowed event-count vectors and diagnostic bins (fixed window Tw).
- V_safe = Delta(X_safe), where X_safe is the finite space of S-field configurations (and thresholded safe sets).
- V_opk = Delta(X_opk), where X_opk is the finite space of op_k token configurations.

In practice, the repo works with empirical summaries in these spaces rather than full distributions.

## 4. Completion/packaging endomap E

### Implemented packaging mechanism

Packaging in this repo is implemented as the P5 update channel (and its meta/op_k extensions):
- `p5_write_step` / `p5_write_step_meta` / `p5_write_step_opk` in `crates/sim-core/src/lib.rs#L1818`

### Explicit canonical lift U_f (prototypes)

We fix a deterministic prototype lift U_f so that E_{tau,f} is a well-defined function.

Baseline prototype state z_0 (deterministic):
- positions: fixed lattice on the torus (index i maps to cell (i mod g, floor(i/g)) with g = gridSize), normalized into [0,1); if n > g^2, wrap modulo g^2.
- w, a, n: all zeros.
- S field and all meta fields: all zeros.
- op_k tokens: uniform per-cell budget (each cell has opBudgetK tokens spread evenly across r offsets; remainder assigned in offset index order).
- phase, p3 observables, clock_state, clock counters: all zeros.

Prototype selection (Dirac form):
- For f_safe: given macrostate x that specifies an S-field (and optionally meta S fields), define z_x by starting from z_0 and overwriting only the relevant S-field entries to match x.
- For f_opk: given macrostate x that specifies op_k tokens, define z_x by starting from z_0 and overwriting only op_k to match x.
- For f_diag: f_diag is observational only and is not used to define E.

Lift definition:

  U_f(delta_x) := delta_{z_x}
  U_f(nu) := sum_x nu(x) delta_{z_x}

This is the repo's analogue of the paper.tex prototype lift. Different U_f choices would yield different empirical E; the above choice is fixed for reproducibility.

### Dynamics-induced completion endomap

Accordingly, we define the completion endomap E on V_safe (and optionally V_opk) as the dynamics-induced map obtained by advancing the simulator for a timescale tau and then applying the lens:

  E_{tau,f}(nu) := Q_f( (U_f nu) P^tau )

where Q_f is the pushforward along f, i.e.

  (Q_f mu)(x) := sum_{z: f(z)=x} mu(z)
  (equivalently, f_# mu).

In Dirac form:

  E_{tau,f}(delta_x) := Q_f( delta_{z_x} P^tau )

where P is the simulator's Markov kernel (implemented by `Sim.step`, `crates/sim-core/src/lib.rs#L287`), f is f_safe or f_opk, and U_f is the fixed lift above. This matches the template in the framework paper.

### Idempotence defect

The paper's idempotence defect is

  delta_{tau,f} := sup_mu ||E_{tau,f}(E_{tau,f}(mu)) - E_{tau,f}(mu)||_TV

No explicit idempotence-defect computation is implemented for E in this repo. Stability is evaluated via descriptive proxies (safe-set fraction, component counts, and qualitative persistence in logs), but delta_{tau,f} is not measured.

## 5. Audit functional A

We use three audit families, each tied to existing code and artifacts:

### A_ACC (affinity audit on coarse event graph)

From Deliverable D:
- A_y = log((N_y^+ + 1)/(N_y^- + 1))
- Sigma_mem = sum_y J_y A_y
- M6 affinity estimator aM6*

See `docs/knowledge/11_deliverable_D_diagnostics.md#L31` and the implementation in `crates/sim-core/src/lib.rs#L2859` and `crates/sim-core/src/lib.rs#L2869`.

This is an ACC-style audit on a coarse event graph (not a full microstate 1-form). It is used as the P6_drive certificate: nonzero M6 affinities indicate a non-exact 1-form on the coarse loop (P6_drive in `paper.tex`).

### A_EP (path-asymmetry proxy)

The simulator accumulates epExactTotal as the sum of log acceptance ratios for accepted moves:
- `accept_move` in `crates/sim-core/src/lib.rs#L2354`
- used in scripts such as `scripts/test-ep-null-tight.mjs`

This is a proxy for path-space KL (Sigma_T). It is not a full path-space KL because log proposal ratios are always 0 in code and only accepted moves are included. Use as a diagnostic proxy, not a formal equality to Sigma_T.

### A_clock (current audit for clock subspace)

Clock drift uses the internal clock state (clock_q / steps) as a directional current in clock experiments:
- clock state in `crates/sim-core/src/lib.rs#L85`
- drift computation in `scripts/test-clock-current.mjs`

### Monotonicity note

The paper requires A to be monotone under coarse-graining. The repo does not implement a formal monotonicity test for these audits; they are used as descriptive diagnostics with controls (null vs drive) to avoid false positives.

## 6. Null regime definition (A_NULL alignment, A_AUT)

### A_NULL (null regime)

Null regime means P3=OFF and P6=OFF, with all active channels using symmetric proposals and Metropolis acceptance. This enforces detailed balance with respect to the stationary measure in Deliverable A.
- Spec: `docs/knowledge/08_deliverable_A_null_stationary_measure.md#L72`
- Implementation: `Sim.step` and `accept_move` (`crates/sim-core/src/lib.rs#L287`, `crates/sim-core/src/lib.rs#L2354`)

Null-regime validation uses:
- Sigma_mem approx 0
- A_y approx 0
- M6 affinities approx 0
- P3 loop approx 0
- energy breakdown via `Sim.energy_breakdown` (`crates/sim-core/src/lib.rs#L723`)

### A_AUT (autonomy)

Protocol phase and clock state are explicit state variables in Z (see `crates/sim-core/src/lib.rs#L65` and `#L85`), so the simulator is autonomous when these are included in the state. Analyses that ignore phase/clock can produce a protocol-trap artifact; P3 diagnostics must not be treated as arrow-of-time without a P6 audit.

## 7. Primitive mapping (P1-P6)

- P1 (operator rewrite): writable couplings w_ij and updates in `p1_write_step` and meta variants (`crates/sim-core/src/lib.rs#L1632`).
- P2 (feasible-set write): apparatus counters a_i via `p2_write_step` / meta (`crates/sim-core/src/lib.rs#L1771`).
- P3 (holonomy / route mismatch): protocol cycling and phase in `protocol_step` with loop diagnostics (`crates/sim-core/src/lib.rs#L2194`, `#L2323`). This is a holonomy diagnostic only; it is not an arrow-of-time certificate.
- P4 (quantized counters): n_counter updates in `p4_write_step` / meta (`crates/sim-core/src/lib.rs#L1718`).
- P5 (packaging): S-field updates and op_k coupling in `p5_write_step*` (`crates/sim-core/src/lib.rs#L1818`). Emergent objects correspond to stable S-field/safe-set patterns under the chosen lens.
- P6 (audit/drive): work terms in acceptance rules using mu(x) (`crates/sim-core/src/lib.rs#L1685` and `#L2595`) and audits via A_ACC / A_EP. P6_drive is identified with nonzero M6 affinities (non-exact 1-form on the coarse loop).

## 7.1 Metrics used for P5/P3/P6

- P5 (emergence/packaging): safe-set fraction/components and S histograms (`apps/web/src/App.tsx#L555`, `crates/sim-core/src/lib.rs#L737`); stability proxies in summaries (e.g., `scripts/run-sweep.mjs` and `scripts/run-meta-sweep.mjs`).
- P3 (holonomy): p3DispMag and p3LoopArea (`crates/sim-core/src/lib.rs#L2323`), reported in logs and UI.
- P6 / P6_drive (audit): A_y, Sigma_mem, and aM6* (`crates/sim-core/src/lib.rs#L2859`), epExactRateWindow (`crates/sim-core/src/lib.rs#L2354`), and clock drift (`scripts/test-clock-current.mjs`).

### Doc-level canonical aliases (no code changes)

- p3HolonomyDispMag := p3DispMag
- p3HolonomyLoopArea := p3LoopArea
- Sigma_mem_proxy := sigmaMem
- ACC_proxy := {A_y, Sigma_mem, aM6*}

## 8. Artifact pointers by claim family (EXPERIMENTS.md)

Each claim references (i) lens f, (ii) packaging E, (iii) audit A, and (iv) artifacts (params, result tables/logs, metric code).

### Base campaigns (C_BASE_NULL_1, C_P6_SEP_1, C_P3_OBS_1, C_P3P6_LONG_1)

- Lens: f_diag (windowed diagnostics)
- Packaging E: E_safe (P5 update channel if pSWrite > 0; otherwise trivial)
- Audit A: A_ACC (A_y, Sigma_mem, M6) and P3 loop (holonomy only)
- Artifacts:
  - Params: inline flags in `EXPERIMENTS.md#L190`, `EXPERIMENTS.md#L225`, `EXPERIMENTS.md#L269`, and `EXPERIMENTS.md#L326` (no preset JSON for E5/E8/E11/E15)
  - Results: `EXPERIMENTS.md#L355` (safe claims), plus E5/E8/E11/E15 logs in the same section
  - Metric code: `crates/sim-core/src/lib.rs#L2859` (affinity), `crates/sim-core/src/lib.rs#L2323` (P3 loop)

### Base retune presets (C_BASE_RETUNE_NULL_1, C_BASE_RETUNE_P6_1, C_BASE_RETUNE_P3_1, C_BASE_RETUNE_P3P6_1)

- Lens: f_diag
- Packaging E: E_safe (P5 active in presets)
- Audit A: A_ACC + P3 loop (holonomy)
- Artifacts:
  - Params: `scripts/params/base_null_balanced.json`, `scripts/params/base_p6_drive.json`, `scripts/params/base_p3_pump_minimal.json`, `scripts/params/base_p3p6_combo_minimal.json`
  - Results: summary table and claim block in `EXPERIMENTS.md#L530`
  - Metric code: `crates/sim-core/src/lib.rs#L2859` and `#L2323`; summary aggregation in `scripts/run-sweep.mjs`

### Meta-layer null and eta alignment (C_META_NULL_1, C_META_ETA_ALIGN_1)

- Lens: f_diag (plus S/W diff diagnostics)
- Packaging E: E_safe across meta layers (P5 meta updates)
- Audit A: A_ACC (Sigma_mem, M6) and cross-layer S/W diffs (descriptive, not audit)
- Artifacts:
  - Params: `scripts/params/meta/meta2_null_decoupled.json`, `scripts/params/meta/meta2_null_coupled.json`
  - Results: summary table and claim block in `EXPERIMENTS.md#L665`
  - Metric code: `scripts/run-meta-sweep.mjs` (S/W diff summaries), `crates/sim-core/src/lib.rs#L1818`

### Clock and TUR campaigns (C_CLOCK_DRIFT_1, C_TUR_1)

- Lens: f_diag + clock lens (clock_q)
- Packaging E: E_safe (P5 channel; clock uses P4 counters as state)
- Audit A: A_clock (drift) and A_EP (epExact rate)
- Artifacts:
  - Params: `scripts/params/clock_code/clock_null.json`, `scripts/params/clock_code/clock_p6.json`, `scripts/params/clock_code/clock_tur_sweep_base.json`
  - Results: tables and claim block in `EXPERIMENTS.md#L727` and `EXPERIMENTS.md#L771`
  - Metric code: `scripts/test-clock-current.mjs`, `scripts/run-clock-tur-sweep.mjs`, `crates/sim-core/src/lib.rs#L1544`

### Code maintenance (C_CODE_MAINT_1)

- Lens: f_safe (S-field mismatch) + A_EP
- Packaging E: E_safe (P5 repair updates)
- Audit A: A_EP (epRate), plus Sdiff/err (descriptive)
- Artifacts:
  - Params: `scripts/params/clock_code/code_null.json`, `scripts/params/clock_code/code_p6_drive.json`, `scripts/params/clock_code/code_p6_clock_gated.json`
  - Results: table and claim block in `EXPERIMENTS.md#L756`
  - Metric code: `scripts/run-code-maintenance.mjs`, `crates/sim-core/src/lib.rs#L1818`

### Exact EP null validation (C_EP_EXACT_NULL_1)

- Lens: f_diag
- Packaging E: E_safe
- Audit A: A_EP (epExactRateWindow)
- Artifacts:
  - Params: `scripts/params/base_null_balanced.json`, `scripts/params/meta/meta2_null_coupled.json`
  - Results: table and claim block in `EXPERIMENTS.md#L798`
  - Metric code: `scripts/test-ep-null-tight.mjs`, `crates/sim-core/src/lib.rs#L2354`

### Clock traversal and orientation (C_TRAVERSAL_NEED_1, C_TRAVERSAL_ORIENT_1)

- Lens: f_safe + clock lens
- Packaging E: E_safe with gated repair (P5 meta)
- Audit A: A_EP (epExact) and clock drift
- Artifacts:
  - Params: `scripts/params/clock_code/code_p6_clock_gated.json`, `scripts/params/clock_code/code_p6_clock_gated_static.json`, `scripts/params/clock_code/code_p6_clock_gated_random.json`
  - Results: traversal table and claim block in `EXPERIMENTS.md#L817`
  - Metric code: `scripts/test-clock-traversal-necessity.mjs`

### Deadline drift and clock EP (C_DEADLINE_DRIFT_1, C_DEADLINE_CLOCK_EP_1)

- Lens: f_safe + clock lens + deadline event summaries
- Packaging E: E_safe with deadline gating
- Audit A: A_EP (epClockRate) and drift current
- Artifacts:
  - Params: `scripts/params/clock_code/deadline_fidelity_found.json`, `scripts/params/clock_code/deadline_fidelity_drift.json`, `scripts/params/clock_code/deadline_fidelity_random.json`, `scripts/params/clock_code/deadline_fidelity_static.json`
  - Results: bootstrap CI table and claim block in `EXPERIMENTS.md#L1050`
  - Metric code: `scripts/run-deadline-success-ci.mjs`, `scripts/run-deadline-event-stats.mjs`, `scripts/run-deadline-phase-diagram.mjs`

### OpK invariants, null EP, coupling effect (C_OPK_INV_1, C_OPK_NULL_EP_1, C_OPK_EFFECT_1)

- Lens: f_opk
- Packaging E: E_opk (op_k update kernel)
- Audit A: A_EP (epExact) plus invariants
- Artifacts:
  - Params: `scripts/params/meta/meta2_null_coupled.json`
  - Results: invariant/EP/effect notes and claim block in `EXPERIMENTS.md#L1093`
  - Metric code: `scripts/test-opcoupling-invariants.mjs`, `scripts/test-opcoupling-null-ep.mjs`, `scripts/test-opcoupling-effect.mjs`, `scripts/opk-metrics.mjs#L34`

### OpK drive selection and hierarchy (C_OPK_DRIVE_SELECT_1, C_OPK_HIER_1)

- Lens: f_opk
- Packaging E: E_opk
- Audit A: A_EP (epOpK) and descriptive hierarchy stats
- Artifacts:
  - Params: `scripts/params/op_coupling/opS_null_energy.json`, `scripts/params/op_coupling/opS_p6_drive_only.json`, `scripts/params/op_coupling/deadline_opk_best.json`
  - Results: ablation/hierarchy tables and claim block in `EXPERIMENTS.md#L1168`
  - Metric code: `scripts/test-opk-drive-selection.mjs`, `scripts/run-opk-hierarchy-search.mjs`, `scripts/opk-metrics.mjs#L34`

### OpK dilution and composed hierarchy (C_OPK_DILUTION_1, C_OPK_COMPOSED_R2_1)

- Lens: f_opk + deadline summaries
- Packaging E: E_opk + E_safe (deadline gating)
- Audit A: A_EP (epTotal) and composed hierarchy metrics
- Artifacts:
  - Params: `scripts/params/op_coupling/deadline_opk_best.json`
  - Results: dilution attribution and composed hierarchy tables with claim blocks in `EXPERIMENTS.md#L1215` and `EXPERIMENTS.md#L1283`
  - Metric code: `scripts/run-deadline-opk-decomposition.mjs`, `scripts/run-opk-composed-hierarchy.mjs`

### OpK weight sweep, CI EP, repair dominance (C_OPK_WEIGHT_NULL_EP_1, C_OPK_CI_EP_1, C_OPK_REPAIR_DOM_1)

- Lens: f_opk + deadline summaries
- Packaging E: E_opk + E_safe
- Audit A: A_EP (epExact/epTotal)
- Artifacts:
  - Params: `scripts/params/op_coupling/deadline_opk_best.json`
  - Results: null EP sweep and CI tables with claim block in `EXPERIMENTS.md#L1312` and `EXPERIMENTS.md#L1373`
  - Metric code: `scripts/test-opk-null-ep-weights.mjs`, `scripts/run-deadline-opk-ci-iso.mjs`, `scripts/run-deadline-opk-repair-budget-curves.mjs`
